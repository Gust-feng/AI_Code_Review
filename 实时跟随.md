# 实时跟随

## 2025-03-15
- 新增 `TaskConfig` 配置，强制任务模式（read_only / safe_write）、项目根目录和 trace_id，所有任务入口 `run_agent` 必须显式传入。
- 引入 `LocalFileToolProvider` + `FileToolProvider` 抽象，所有读写工具走同一网关，写入必定经过备份与路径校验，为未来 MCP Provider 预留接口。
- 在 `agent_core.tasks.task_runner.run_agent` 中实现最多 20 步的多轮工具循环：模型自行决定是否继续调用工具，我们只负责执行、回填结果并强制步数上限。
- 对每个任务落地 JSON trace（`traces/{trace_id}.json`），记录 LLM 响应、工具调用、错误、最终状态，方便后续审计与回溯。
- 工具有了新的结构化定义（read/list/search/write），并自动根据 `TaskConfig.mode` 拒绝写操作。
- GUI 侧：`agent_core/gui/test_gui.py` 增加“项目目录”选择（绑定 `self.project_root`），以及“任务Agent”按钮，调用 `TaskConfig` + `run_agent`，只有在选定 project_root 且配置了 API Key 时才能执行任务。
- 新增 “多扫描器子系统” (`agent_core/scanners/__init__.py`)，统一定义 `Issue` 数据结构、Scanner 协议，并实现 Semgrep/Bandit/ESLint 适配器和 `run_all_scanners(project_root)`，支持自动检测适用扫描器、执行命令、解析 JSON 输出以及在失败时返回结构化错误信息。
- run_ide_chat / stream_ide_chat 现在要求显式传入 project_root（GUI 已传递），内部按 (provider, model, root) 维度缓存 Agent，并为每个根目录创建专属 ToolExecutor，工具路径与读写权限不再共享。
- GUI 的对话发送也会附带 project_root 元数据，阻止未选择目录的任务；同时新增 `run_static_analysis` 工具，可让 LLM 直接触发多扫描器合并结果。
- logging：`JsonFormatter` 现在支持缩进输出，文件日志默认为格式化 JSON；新增 GUI 日志窗口（`LogWindow`）+ `GuiLogHandler`，在主 GUI 启动时自动弹出小窗口实时显示普通日志，便于分析工具调用、token 消耗等上下文；终端保留关键 JSON 日志输出。
- 修复任务：日志窗口方法 `_start_log_window` 已放回 `App` 类内部并在 GUI 关闭时自动清理，解决启动错误。
- GUI 重构：界面采用“左侧 Provider/工具 + 右侧快速配置/聊天”布局，常用操作（项目目录、模型切换、对话输入）置于顶部；API Key/.env 等放入可折叠的“高级设置”，并新增内置工具列表展示。
